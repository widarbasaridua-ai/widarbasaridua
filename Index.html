<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Jimpitan Digital</title>
    
    <!-- PWA CONFIG -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico">
    
    <!-- MINIMAL CSS -->
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:500px; margin:auto; background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .logo { text-align:center; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
        .logo span { font-size:40px; display:block; margin-bottom:10px; }
        .tabs { display:flex; margin-bottom:25px; background:#f8f9fa; border-radius:8px; overflow:hidden; }
        .tab { flex:1; padding:15px; text-align:center; cursor:pointer; font-weight:600; color:#666; transition:all 0.3s; border-bottom:3px solid transparent; }
        .tab.active { color:#667eea; border-bottom-color:#667eea; background:white; }
        #contentArea { min-height:300px; }
        .status-bar { position:fixed; top:10px; right:10px; z-index:1000; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold; }
        .online { background:#27ae60; color:white; }
        .offline { background:#e74c3c; color:white; }
        @media (max-width:480px) { .container { padding:15px; } .tabs { flex-direction:column; } }
    </style>
</head>
<body>
    <!-- STATUS BAR -->
    <div id="statusBar" class="status-bar online">üü¢ ONLINE</div>
    
    <div class="container">
        <div class="logo">
            <span>üí∞</span>
            <h1>Sistem Jimpitan Digital</h1>
            <div style="font-size:12px; color:#666;">v2.0 Optimized</div>
        </div>
        
        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="loadTab('transaksi')">üí≥ Transaksi</div>
            <div class="tab" onclick="loadTab('dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="loadTab('nasabah')">üë• Nasabah</div>
            <div class="tab" onclick="loadTab('saldo')">üí∞ Saldo</div>
        </div>
        
        <!-- CONTENT AREA -->
        <div id="contentArea">
            <div style="text-align:center; padding:50px 20px; color:#999;">
                <div class="loading"></div>
                <div style="margin-top:15px;">Memuat aplikasi...</div>
            </div>
        </div>
    </div>

    <!-- CORE JS ONLY -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz32KOmnNuKUT06zLEEm16i5ozHq9ZKOHa88ysxtkLp55RXTKDIXiH_MYEpkEuBOS7z/exec';
        let currentTab = 'transaksi';
        
        // ONLINE/OFFLINE DETECTION
        function updateStatus() {
            const statusBar = document.getElementById('statusBar');
            statusBar.className = `status-bar ${navigator.onLine ? 'online' : 'offline'}`;
            statusBar.innerHTML = navigator.onLine ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';
        }
        
        // LOAD TAB CONTENT
        async function loadTab(tabName) {
            currentTab = tabName;
            
            // Update UI tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show loading
            document.getElementById('contentArea').innerHTML = `
                <div style="text-align:center; padding:30px 20px; color:#999;">
                    <div class="loading"></div>
                    <div style="margin-top:15px;">Memuat ${tabName}...</div>
                </div>
            `;
            
            try {
                // Fetch UI from Apps Script
                const response = await fetch(`${API_URL}?action=getUI&tab=${tabName}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('contentArea').innerHTML = result.html;
                    
                    // Load tab-specific JS
                    if (result.js) {
                        eval(result.js);
                    }
                    
                    // Initialize with data
                    if (result.data && window.initTab) {
                        window.initTab(result.data);
                    }
                } else {
                    showError('Gagal memuat konten');
                }
            } catch (error) {
                showError('Koneksi error. Coba refresh.');
            }
        }
        
        // UTILITY FUNCTIONS
        function showError(msg) {
            document.getElementById('contentArea').innerHTML = `
                <div style="background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; text-align:center;">
                    ‚ùå ${msg}
                    <button onclick="loadTab(currentTab)" style="margin-top:10px; padding:8px 15px; background:#667eea; color:white; border:none; border-radius:5px;">
                        Coba Lagi
                    </button>
                </div>
            `;
        }
        
        function formatRupiah(num) {
            return 'Rp ' + parseInt(num).toLocaleString('id-ID');
        }
        
        // INITIALIZE
        window.addEventListener('load', () => {
            updateStatus();
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            loadTab('transaksi');
        });
        
        // SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>
</html>